---
title: "In-class Demo of Dashboard"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: scroll
    css: styles.css
    #vs. fill
    #fill leaves you with a fixed amount of space
    #theme: spacelab
---

```{r setup, include=FALSE}
library(flexdashboard)
library(tidyverse)
#install.packages("plotly")
library(plotly)
library(rio)
library(here)
library(colorblindr)
library(tidytext)

```

```{r}
data <- import(here("reg_data.csv"))
int <- import(here("text_data.xlsx"))


my_colors <- c("darkblue","darkmagenta", "chartreuse", "cyan","tomato")
```

Demographics
==========


Column {data-width=600}
-----------------------------------------------------------------------

### Education

```{r}

data %>% 
  ggplot(aes(edu)) + 
  geom_bar(aes(fill = edu), show.legend = FALSE) + 
  labs(x = "education level", y = "number of people", fill = "Education Level") + coord_flip() + theme(axis.title.y=element_blank()) + scale_fill_manual(values = my_colors)


# ggplot(df, aes(x=x, y=y))+
#   geom_point() +
#   theme(axis.text.x=element_blank(), #remove x axis labels
#         axis.ticks.x=element_blank(), #remove x axis ticks
#         axis.text.y=element_blank(),  #remove y axis labels
#         axis.ticks.y=element_blank()  #remove y axis ticks
#         )

#cvd_grid(g)
```


### Insulin Therapy

```{r}

data %>% 
  ggplot(aes(insulin)) + 
  geom_bar(aes(fill = insulin), show.legend = FALSE) + 
  labs(x = "Gender", y = "number of people", fill = "insulin") + theme(axis.title.x=element_blank()) + scale_fill_manual(values = my_colors)

```


Column {data-width=600}
-----------------------------------------------------------------------




### Gender  {data-padding=10}

```{r}

data %>% 
  ggplot(aes(gender)) + 
  geom_bar(aes(fill = gender), show.legend = FALSE) + 
  labs(x = "Gender", y = "number of people", fill = "Gender") + theme(axis.title.x=element_blank()) +  scale_fill_manual(values = my_colors)

```

### Place

```{r}
data %>% 
  ggplot(aes(rural_urban)) + 
  geom_bar(aes(fill = rural_urban), show.legend = FALSE) + 
  labs(x = "Rural/Urban", y = "number of people", fill = "Rural/Urban") + theme(axis.title.x=element_blank()) +  scale_fill_manual(values = my_colors)

```

----------------------


Understanding the Data
=======================

*Describe the scales here

### First exploration with interaction

```{r}
library(plotly)

fig <- plot_ly(data = data,
               x = ~ywd,
               y = ~age,
               type = 'scatter', 
               mode = 'markers') 

fig
```

### Colors are interviewed, Grey are randomly selected for pre-registration analyses

```{r}
library(ggrepel)
data <- data %>% 
  mutate(int_number = case_when(
part_id == "R_cLVjYpvjfQixvpv" ~ 1,
part_id == "R_3Eyawv7ZHbUXMX8" ~ 2,
part_id == "R_1fdCp8U6J7TIpPG" ~ 3, 
part_id == "R_3nT0W62FHiaCGPg" ~ 4,   
part_id == "R_1g6IuFecvJV6n6x" ~ 5, 
part_id == "R_1mr573O3Ezhk8XJ" ~ 6,
part_id == "R_R3vFesQEw5vyUyB" ~ 7, 
part_id == "R_2TOeaDtBAd8rJgQ" ~ 8,
part_id == "R_1jTbJ73cP1sJNAX" ~ 9,
part_id == "R_2aEnOJSABPWYd6B" ~ 10))

data$int_number <- as.factor(data$int_number)

p <- data %>% 
ggplot(aes(dds_means, des_score)) + 
geom_point(aes(color = int_number), size = 5)   + 
geom_text_repel(data = data, aes( label = ywd), max.overlaps = Inf) +
  theme_bw() + 
  labs(x = "Diabetes Distress", y = "Diabetes Empowerment", caption = "mean values from validated scales", title = "Years with Diabetes: looking at distress and empowerment")

p
```




Stats!
===========

```{r include=FALSE}
data <- data %>%
  mutate(
    across(
      # ^means begins with. 0-9 are the possible numbers and {1,2} means it 
      # could be one or two digits
      matches("^resources_[0-9]{1,2}$"), 
# need to ask Sara about what the period inside parens indicates
      ~ ifelse(is.na(.), 0, 1)))


```

```{r include=FALSE}

data$res_sum <- data %>% 
  select(resources_1:resources_21)%>%
  rowSums(na.rm=TRUE)

```

### Initial Peak

```{r,fig.width=7,fig.height=4}
data %>% 
  ggplot(aes(res_sum, des_score)) + 
  geom_point(aes(size = chai_means),color = "purple3") +           scale_color_manual(values = my_colors)+ 
  theme_classic() + 
  theme(axis.line = element_line(colour = "darkmagenta", 
       linewidth = 2, linetype = "solid")) +  scale_fill_manual(values = my_colors) + 
  xlim("1", "2", "3", "4", "5", "6", "7", "8", "9", "10", "11", "12", "13") +
  labs(x = "Number of Resources Used", y = "Diabetes Empowerment", size = "Health Engagement Score")

```




### Regression Line Outcome 1

```{r}
data %>% 
ggplot(aes(res_sum, des_score)) + 
  geom_point()+ 
  geom_smooth(method = "lm", color = "deeppink4") + theme(panel.grid = element_blank()) + labs(x = "Sum of Resources", y = "Diabetes Empowerment Score")
```


### Regression Line Outcome 2

```{r}
data %>% 
ggplot(aes(res_sum, percent_time_70_180)) + 
  geom_point()+ 
  geom_smooth(method = "lm", color = "deeppink4") + theme(panel.grid = element_blank()) + labs(x = "Sum of Resources", y = "Time in Target Range")
```


### Regression Line Outcome 3 

```{r}
data %>% 
ggplot(aes(res_sum, dds_means)) + 
  geom_point()+ 
  geom_smooth(method = "lm", color = "deeppink4") + theme(panel.grid = element_blank()) + labs(x = "Sum of Resources", y = "Diabetes Distress Score")
```



### Looking ahead 

* The idea is to run t-tests, regressions, and a moderation and add visuals of those here

------

```{r}
library(wordcloud2) 

 
int2 <- int %>% 
unnest_tokens(word, lows) %>% 
  select(word, part_id) |>
  anti_join(stop_words)



#letterCloud( frequency_dataframe, word = "LOW", color="white", backgroundColor="deepskyblue")

#letterCloud( demoFreq, word = "PEACE", color="white", backgroundColor="pink")

#view(demoFreq)

#wordcloud2(data=demoFreq, size=1.6)


frequency_dataframe = int2 %>% count(word) %>% arrange(desc(n))

letterCloud( frequency_dataframe, word = "LOW", color="brown", backgroundColor= "green")

```


Interviews 
=================================


### **Description of Low Blood Sugar...**

```{r echo=FALSE}
#letterCloud( frequency_dataframe, word = "LOW", color="black", backgroundColor="deepskyblue")

draft <- wordcloud2(data=frequency_dataframe, size=1.6)

htmlwidgets::saveWidget(draft, 
                        "draft.html",
                        selfcontained = F, libdir = "lib")
```
<iframe src="draft.html" height="405" width="720" style="border: 1px solid #464646;" allowfullscreen="" allow="autoplay"></iframe>

-----------


### Words about Lows

```{r}
#{.storyboard} removed this for now

dat <- left_join(data, int)


dat <- dat %>% 
unnest_tokens(word, lows)

dat %>% 
anti_join(stop_words) %>% 
  filter(word != "low",word !="yeah",word != "ago",word != "feel", word !="feeling", word != "lows", word != "describe", word != "super", word != "sugar", word != "straight", word != "start", word != "dexcom", word != "feels", word != "feelings", word != "extreme", word != "gonna", word != "guys") %>% 
count(word, sort = TRUE) %>% 
  mutate(word = reorder(word, n)) %>% # make y-axis ordered by n
  slice(1:20) %>% # select only the first 15 rows
  ggplot(aes(n, word)) +
  theme_minimal() +
    geom_col(fill = "darkorchid")+ theme(panel.grid.major.x = element_line(color = "grey",size = 0.25, linetype = 1), panel.grid = element_blank()) + labs( x = "Count", y = "Word", Title = "Word frequencies in posts", subtitle = "Top 20 words displayed", caption = "From first 5 interviews - transcription in progress")


```

-----

### **Description of High Blood Sugar**

~interview transcription still in progress~ 

-------------
Key Findings
========================
### Results

Data Collection is ongoing: these graphs show the first 15 people in the study

* This is where the main results will be summarized and ideally graphed in a way that shows general trends and makes results digestable. The take-away will not be too meaningful with the current 15 data points but the full dataset can be plugged in once data collection is over and the direction of the results can be re-written accordingly. 

